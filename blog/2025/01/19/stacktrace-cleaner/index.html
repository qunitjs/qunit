<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/favicon.svg">
<link rel="stylesheet" href="/assets/styles.css?v=24854486" media="screen">
<link rel="alternate" type="application/rss+xml" href="/feed.xml" title="QUnit">
<title>Cleaner stack traces in QUnit | QUnit</title><meta property="og:title" content="Cleaner stack traces in QUnit"><meta name="description" content="Stack traces shown in the QUnit CLI now remove or grey out internal calls by Node.js and QUnit."><meta property="og:description" content="Stack traces shown in the QUnit CLI now remove or grey out internal calls by Node.js and QUnit."><link rel="me" href="https://fosstodon.org/@qunit"><meta name="twitter:card" content="summary_large_image"><meta property="og:type" content="article"><meta property="article:published_time" content="2025-01-19T00:00:00+00:00"><meta name="author" content="Timo Tijhof">
<body>
    <header class="site-header" role="banner">
        <div class="site-header-wrapper wrapper">
            <a class="site-logo" href="/"><img src="/img/logo-with-colored-text.svg" alt="QUnit" width="250" height="72"></a><typesense-minibar data-origin="https://typesense.jquery.com" data-collection="qunitjs_com" data-key="Zh8mMgohXECel9wjPwqT7lekLSG3OCgz" data-foot="true">
<form role="search" action="https://duckduckgo.com">
    <input type="search" name="q" aria-label="Search" placeholder="Search..." autocomplete="off">
    <input type="hidden" name="sites" value="qunitjs.com">
</form>
</typesense-minibar>
<nav class="site-nav"><ul class="site-nav-list"><li class="site-nav-item has-sub-list"><span class="site-nav-link has-sub-list" tabindex="0">Guides</span>
                        <ul class="site-nav-sub-list"><li><a class="site-sub-nav-link" href="/intro/">Getting Started</a></li><li><a class="site-sub-nav-link" href="/browser/">Browser Runner</a></li><li><a class="site-sub-nav-link" href="/browser/#browser-support">Browser Support</a></li><li><a class="site-sub-nav-link" href="/cli/">Command-line Interface</a></li><li><a class="site-sub-nav-link" href="/intro/#download">Download</a></li><li><a class="site-sub-nav-link" href="/plugins/">Plugins</a></li><li><a class="site-sub-nav-link" href="/upgrade-guide-2.x/">QUnit 2.0 Upgrade Guide</a></li></ul></li><li class="site-nav-item"><a class="site-nav-link" href="/api/">Documentation</a></li><li class="site-nav-item"><a class="site-nav-link" href="/blog/">Blog</a></li><li class="site-nav-item has-sub-list"><span class="site-nav-link has-sub-list" tabindex="0">Community</span>
                        <ul class="site-nav-sub-list"><li><a class="site-sub-nav-link" href="/intro/#support">Support &amp; Chat</a></li><li><a class="site-sub-nav-link" href="/projects/">Who&#39;s using QUnit?</a></li><li><a class="site-sub-nav-link" href="/about/">About QUnit</a></li><li><a class="site-sub-nav-link" href="/badge/">Badge</a></li><li><a class="site-sub-nav-link" href="/brand/">Brand Guidelines</a></li></ul></li></ul></nav>
            <div class="site-toggles">
                <button class="search-toggle toggle" aria-expanded="false">
                    <span class="screen-reader-text">Search</span>
                    <svg class="icon aa-input-icon" aria-hidden="true" viewBox="654 -372 1664 1664" height="20">
                        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z"/>
                    </svg>
                </button>
                <button class="nav-toggle toggle" data-opens=".site-nav" aria-expanded="false">
                    <span class="screen-reader-text">Menu</span>
                    <svg class="icon icon-nav-toggle" aria-hidden="true" viewBox="0 0 100 100" height="20">
                        <path d="M5,16h90v16H5z"/>
                        <path d="M5,48h90v16H5z"/>
                        <path d="M5,80h90v16H5z"/>
                    </svg>
                </button>
                <script type="module">
                const searchToggle = document.querySelector('.search-toggle');
                const searchForm = document.querySelector('typesense-minibar');
                const searchInput = searchForm.querySelector('input[type=search]');
                function searchFn(newState) {
                    searchToggle.setAttribute('aria-expanded', String(newState));
                    searchForm.style.display = newState ? 'block' : '';
                    if (newState) {
                        searchInput.focus();
                    }
                }
                const navToggle = document.querySelector('.nav-toggle');
                const navToggleOpens = document.querySelector(navToggle.dataset.opens);
                function navFn(newState) {
                    navToggle.classList.toggle('opened', newState);
                    navToggleOpens.classList.toggle('opened', newState);
                    navToggle.setAttribute('aria-expanded', String(newState));
                    navToggleOpens.setAttribute('aria-expanded', String(newState));
                }
                searchToggle.addEventListener('click', () => {
                    navFn(false);
                    searchFn(searchToggle.getAttribute('aria-expanded') !== 'true');
                });
                navToggle.addEventListener('click', () => {
                    searchFn(false);
                    navFn(!navToggle.classList.contains('opened'));
                });
                </script>
            </div>
        </div>
    </header>
    <div class="main main--columns wrapper">
<div class="content" role="main">
<article>
	<header>
		<h1>Cleaner stack traces in QUnit</h1><p class="post-meta byline">Posted on <time pubdate datetime="2025-01-19T00:00:00+00:00">19 January 2025</time> by <span class="author vcard"><a rel="author" class="url fn n" href="/blog/author/krinkle/">Timo Tijhof</a></span></p>
	</header>
	<p>Stack traces shown in the QUnit CLI now remove or grey out internal calls by Node.js and QUnit.</p>

<h2 id="background">Background</h2>

<p>QUnit has always omitted its own source lines from stack traces when showing assertion failures. <sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">[1]</a></sup></p>

<p>This means we can report assertion failures with a stack that is just one level deep, pointing directly at your test file, to the line where the assertion happens.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">QUnit</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">banana</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">actual</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">This is actual.</span><span class="dl">'</span><span class="p">;</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nf">strictEqual</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="dl">'</span><span class="s1">This is expected.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-tap highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gr">not ok</span> <span class="mi">2</span> banana
  ---
  actual  : This is actual.
  expected: This is expected.
  stack: |
        at /test/example.js:3:10
</code></pre></div></div>

<figure><img src="/resources/2025-stacktrace-assert-html.png" width="560" height="244" alt="Screenshot of QUnit test results in a web browser.
1) apple
2) banana
Expected: This is expected.
Result    This is actual.
Source:   @/test/example.js:3:10
" /></figure>

<p>The “real” stack trace is actually quite a bit longer, but we rebase it to become trace for your assertion. We remove lines before your assertion point (i.e. QUnit calling your test function), and remove any calls after that point (i.e. code inside an assert function).</p>

<p>This works well in browsers. But, when it comes to Node.js, we can do better!</p>

<h2 id="nodejs-runtime-internals">Node.js runtime internals</h2>

<p>Web browsers generally don’t expose their own internals to stack traces at all. For example, the internals of <code class="language-plaintext highlighter-rouge">fetch()</code>, or <code class="language-plaintext highlighter-rouge">setTimeout()</code>. <sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">[2]</a></sup> Node.js implements many of its internals in JavaScript, which are sometimes visible in a stack trace.</p>

<p>Let’s look a slow example test:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">QUnit</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">slow example</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nf">timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="k">async</span><span class="p">();</span>
  <span class="c1">// Never done()</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Status quo with QUnit 2.23.1:</p>

<div class="language-tap highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">TAP version 13
</span><span class="gr">not ok</span> <span class="mi">1</span> slow example
  ---
  message: Test took longer than 100ms; test timed out.
  severity: failed
  stack: |
        at listOnTimeout (node:internal/timers:573:17)
        at process.processTimers (node:internal/timers:514:7)
  ...
<span class="kd">1..1</span><span class="c">
# pass 0
# skip 0
# todo 0
# fail 1
</span></code></pre></div></div>

<p>Notice the function calls inside the virtual <code class="language-plaintext highlighter-rouge">note:internal</code> module?</p>

<h3 id="hide-internal-frames">Hide internal frames</h3>

<p>While these functions are not called inside QUnit, we hide them because this timer is scheduled by QUnit. In this case, there are other stack frames and we can omit the trace entirely, for an even cleaner result. The same result in QUnit 2.24.0:</p>

<div class="language-tap highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">TAP version 13
</span><span class="gr">not ok</span> <span class="mi">1</span> slow example
  ---
  message: Test took longer than 100ms; test timed out.
  severity: failed
  ...
<span class="kd">1..1</span><span class="c">
# pass 0
# skip 0
# todo 0
# fail 1
</span></code></pre></div></div>

<h3 id="grey-out-nodejs-internals">Grey out Node.js internals</h3>

<p>Let’s look at a slightly more involved example, where your own code schedules a timer.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">QUnit</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">assert example</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="k">async</span><span class="p">();</span>
  <span class="nf">setTimeout</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nf">false</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">);</span>
    <span class="nf">done</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>
<div class="figure-row">
<figure><img src="/resources/2025-stacktrace-assert-tap-before.png" width="463" height="241" alt="not ok 1 assert example. actual: true. expected: false. stack: at assert-example.js, at node:internal/timers, at node:internal/timers" /><figcaption>QUnit 2.23.0</figcaption></figure>
<figure><img src="/resources/2025-stacktrace-assert-tap-after.png" width="463" height="241" alt="" /><figcaption>QUnit 2.24.0</figcaption></figure>
</div>

<p>In this case, we can’t remove any frames. We should report errors from user code with the same level of detail as Node.js would, if you ran it outside a test. But, what we can do is grey out these <code class="language-plaintext highlighter-rouge">node:internal</code> frames, and draw attention to what is most likely of interest.</p>

<h2 id="uncaught-exceptions">Uncaught exceptions</h2>

<p>The above examples were about stack traces that originate from inside a test case.</p>

<p>We also format stack traces when reporting uncaught exceptions (a.k.a. “global failure”). This includes errors that bubble up to <code class="language-plaintext highlighter-rouge">window.onerror</code> or <code class="language-plaintext highlighter-rouge">process.on('uncaughtException', …)</code>, as received by <a href="/api/extension/QUnit.onUncaughtException/"><code class="language-plaintext highlighter-rouge">QUnit.onUncaughtException</code></a>.</p>

<p>As of QUnit 2.24 we now apply the same stack trace cleaner when formatting uncaught exceptions.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// example.js</span>
<span class="nx">QUnit</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qunit example.js
</code></pre></div></div>

<div class="figure-row">
<figure><img src="/resources/2025-stacktrace-error-before.png" width="540" height="302" alt="Failed to load file example.js. TypeError: eventName must be a string. at qunit.js, at example.js, at node:internal/cjs/loader." /><figcaption>QUnit 2.23.1</figcaption></figure>
<figure><img src="/resources/2025-stacktrace-error-after.png" width="540" height="288" alt="Failed to load file example.js. TypeError: eventName must be a string. at example.js, at node:internal/cjs/loader." /><figcaption>QUnit 2.24.0</figcaption></figure>
</div>

<p>Notice the removal of the first <code class="language-plaintext highlighter-rouge">qunit.js</code> call, which lets the trace starts cleanly at <code class="language-plaintext highlighter-rouge">example.js</code>. The other internal calls are greyed out.</p>

<h3 id="trimming-traces">Trimming traces</h3>

<p>For assertion failures and uncaught exceptions alike, we only trim internal frames from the start or end of a stack. Removing frames from the middle would falsely present a call relationship that never happend, and would cause confusion among developers. Instead, frames we can’t trim, are greyed out instead. This is similar to Node.js’s own error formatter does.</p>

<h2 id="tap-reporter">TAP reporter</h2>

<p>These changes are applied to the TAP reporter, which the QUnit CLI uses by default. If you use the TAP reporter in browser environments, the same improvements apply there as well.</p>

<h2 id="see-also">See also</h2>

<ul>
  <li><a href="https://github.com/qunitjs/qunit/pull/1789">Exclude or grey internal frames in error stacks · Pull Request #1789</a></li>
  <li><a href="https://github.com/qunitjs/qunit/pull/1795">Apply trace cleaning to assertion stack as well · Pull Request #1795</a></li>
  <li><a href="https://github.com/qunitjs/qunit/pull/1794">Remove confusing “expected: undefined” under errors · Pull Request #1794</a></li>
  <li><a href="https://github.com/qunitjs/qunit/pull/1801">Limit colors in TAP reporter to test names · Pull Request #1801</a></li>
  <li><a href="/blog/2024/12/06/qunit-2-23-1/">QUnit 2.23.1 Release</a></li>
  <li><a href="/blog/2025/01/20/qunit-2-24-0/">QUnit 2.24.0 Release</a></li>
</ul>

<h2 id="footnotes">Footnotes</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>This was released with QUnit 1.7 back in 2012 (<a href="https://github.com/qunitjs/qunit/commit/171ad8f042007e795766893a701d9315bdedeef1">commit</a>). <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>This is in part because native browser code isn’t written in JavaScript, so the JavaScript stack is naturally limited to your code only. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</article></div>
<aside class="sidebar" role="complementary">

	<h4 class="sidebar-title-open"><a href="/blog/">Recent blog posts</a></h4>
	<ul class="sidebar-list"><li class="sidebar-item">
		<a href="/blog/2025/01/20/qunit-2-24-0/">QUnit 2.24.0 Released: Cleaner traces and new CLI file extensions</a>
	</li><li class="sidebar-item sidebar-item-active">
		<a href="/blog/2025/01/19/stacktrace-cleaner/">Cleaner stack traces in QUnit</a>
	</li><li class="sidebar-item">
		<a href="/blog/2024/12/06/qunit-2-23-1/">QUnit 2.23.1 Released: Bug fixes</a>
	</li><li class="sidebar-item">
		<a href="/blog/2024/12/03/qunit-2-23-0/">QUnit 2.23.0 Released: Automatic labels</a>
	</li><li class="sidebar-item">
		<a href="/blog/2024/08/18/qunit-2-22-0/">QUnit 2.22.0 Released: Add test.if</a>
	</li></ul>

	<h4 class="sidebar-title-open">Tags</h4>
	<ul class="sidebar-list"><li class="sidebar-item">
		<a href="/blog/tag/feature/">Feature</a>
	</li><li class="sidebar-item">
		<a href="/blog/tag/release/">Release</a>
	</li></ul>

	<h4 class="sidebar-title-open"><a href="/blog/archive/">Archives</a></h4>
	<ul class="sidebar-list"><li class="sidebar-item">
		<a href="/blog/2025/">2025</a>
	</li><li class="sidebar-item">
		<a href="/blog/2024/">2024</a>
	</li><li class="sidebar-item">
		<a href="/blog/2023/">2023</a>
	</li><li class="sidebar-item">
		<a href="/blog/2022/">2022</a>
	</li><li class="sidebar-item">
		<a href="/blog/2021/">2021</a>
	</li><li class="sidebar-item">
		<a href="/blog/2020/">2020</a>
	</li><li class="sidebar-item">
		<a href="/blog/2019/">2019</a>
	</li><li class="sidebar-item">
		<a href="/blog/2018/">2018</a>
	</li><li class="sidebar-item">
		<a href="/blog/2017/">2017</a>
	</li><li class="sidebar-item">
		<a href="/blog/2016/">2016</a>
	</li><li class="sidebar-item">
		<a href="/blog/2015/">2015</a>
	</li><li class="sidebar-item">
		<a href="/blog/2014/">2014</a>
	</li><li class="sidebar-item">
		<a href="/blog/2013/">2013</a>
	</li><li class="sidebar-item">
		<a href="/blog/2012/">2012</a>
	</li><li class="sidebar-item">
		<a href="/blog/2011/">2011</a>
	</li></ul>
</aside>

</div>

    <footer class="site-footer">
        <div class="wrapper">
            <p class="external-links">
                <a href="https://github.com/qunitjs" target="_blank" rel="noopener">GitHub</a>
                <a href="/intro/#support" target="_blank" rel="noopener">Chat</a>
                <a href="https://fosstodon.org/@qunit" target="_blank" rel="noopener">Mastodon</a>
                
                <a href="https://bsky.app/profile/qunitjs.com" target="_blank" rel="noopener">Bluesky</a>
                
                <a href="https://twitter.com/qunitjs" target="_blank" rel="noopener">Twitter</a>
                </p>
            <p class="copyright">Copyright <a href="https://openjsf.org/" target="_blank" rel="noopener">OpenJS Foundation</a> and contributors.<br><a href="https://github.com/qunitjs/qunit/blob/main/docs/_posts/2025-01-19-stacktrace-cleaner.md">Edit this page</a></p>
        </div>
    </footer><script defer type="module" src="/assets/typesense-minibar.js?v=830f1ee1"></script></body>
</html>
